<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cloudok.bbs.mapper.PostMapper">

	<select id="getMyCollectPosts" parameterType="Map" resultMap="postMap">
		select
		<include refid="columns"></include>
		from bbs_post t inner join bbs_collect pt on t.id = pt.business_id and
		pt.deleted=false and t.deleted=false and pt.create_by = #{memberId}
		limit #{start},#{end}

	</select>

	<select id="getMyCollectPostsCount" parameterType="Map"
		resultType="long">
		select count(1)
		from bbs_post t inner join bbs_collect pt on t.id = pt.business_id and
		pt.deleted=false and t.deleted=false and pt.create_by = #{memberId}
	</select>

	<update id="updateByMember" parameterType="com.cloudok.bbs.po.PostPO">
		update bbs_post set
		content=#{content},attach_ids=#{attachIds},topic_type=#{topicType},topic_id=#{topicId},topic_name=#{topicName},topic_icon=#{topicIcon},
		<include refid="com.cloudok.core.mybatis.BaseMapper.updateBaseColumns" />
		<where>
			<include refid="com.cloudok.core.mybatis.BaseMapper.byId" />
		</where>
	</update>
	
	<select id="getPeersCount" parameterType="Map"
		resultType="long">
		select count(distinct t.create_by) from bbs_post t where t.deleted=false and t.topic_id=#{topicId} and t.topic_type=#{topicType}
	</select>
	
	<update id="updateThumbsUpCount" parameterType="Map">
		update bbs_post set thumbs_up_count = (select count(1) from bbs_thumbs_up where business_id= #{postId} and deleted=false) where id = #{postId}
	</update>
	<update id="updateCommentCount" parameterType="Map">
		update bbs_post set comment_count = (select count(1) from bbs_comment where post_id= #{postId} and deleted=false) where id = #{postId}
	</update>
</mapper>